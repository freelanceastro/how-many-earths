<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Night Sky D3 Demo</title>
<script src="http://d3js.org/d3.v3.min.js"></script>
<style>
body {overflow: hidden; margin: 0px;}
</style>
<body>
<script>

var width = window.innerWidth,
	height = window.innerHeight;

var initial_ra = -115,  // in degrees
	initial_dec = -45;

var min_magnitude = 5,
	magnitude_scaling = .75;

var projection = d3.geo.stereographic()
// var projection = d3.geo.gnomonic()
    .clipAngle(140)
    .scale(2000)
    // .translate([width, height])
	// .scale(1000)
	.translate([width/2, height/2])
    .precision(10)
 	.rotate([initial_ra, initial_dec]);

var path = d3.geo.path()
    .projection(projection)
	.pointRadius(function(d){
		return Math.max(0, magnitude_scaling*(min_magnitude - d.properties.brightness));
	});
	
var kepler_path = d3.geo.path()
    .projection(projection);

var color = d3.scale.linear()
				.domain([-2.0, 0.2, 5.5])
				.range(["blue", "white", "red"]);

var λ = d3.scale.linear()
    .domain([0, width])
    .range([-180, 180]);

var φ = d3.scale.linear()
    .domain([0, height])
    .range([90, -90]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var mapx = width/2, 
	mapy = height/2;
	
var dragmove = function() {
  	mapx += d3.event.dx;
	mapy += d3.event.dy;
  	projection.rotate([λ(mapx) + initial_ra, φ(mapy) + initial_dec]);
  	svg.selectAll(".star").attr("d", path);
  	svg.selectAll(".kepler").attr("d", kepler_path);
	svg.selectAll(".constellation").attr("d", kepler_path);
};

var dragobj = d3.behavior.drag().on("drag", dragmove);

d3.json("new_stars.geojson", function(error, stars) {
	d3.json("keplerFOV.geojson", function(error, keplerfov){
		d3.json("constellations_collection.geojson", function(error, constellations){
	
			
		svg.append("rect")
			.attr("width", width)
			.attr("height", height)
			.attr("fill", "black");

	 	svg.selectAll("path")
	 		  		.data(stars)
	 		  		.enter()
	 		  		.append("path")
	 				.attr("class", "star")
	 		      	.attr("d", path)
	 		  		.attr("fill", function(d){return color(d.properties.color)});
		
		svg.append("path")
			.datum(keplerfov)
			.attr("class", "kepler")
			.attr("d", kepler_path)
			.attr("fill", "none")
			.attr("stroke", "white");
			
		svg.append("path")
			.datum(constellations)
			.attr("class", "constellation")
			.attr("d", kepler_path)
			.attr("fill", "none")
			.attr("stroke", "white");
		
		projection.scale(1000);		
		
		svg.selectAll(".star")
			.transition()
			.delay(5000)
			.duration(1000)
			.attr("d", path);
		
		svg.selectAll(".kepler")
			.transition()
			.delay(5000)
			.duration(1000)
			.each("end", function(){
				d3.select(this).attr("transform", "scale(1)");
				d3.select(this).attr("d", kepler_path);
				})
			// .attr("d", kepler_path);   // can't do it this way, it behaves strangely if you do.
			.attr("transform", "scale(0.5)translate(" + width/2 + "," + height/2 + ")");
			
		svg.selectAll(".constellation")
			.transition()
			.delay(5000)
			.duration(1000)
			.each("end", function(){
				d3.select(this).attr("transform", "scale(1)");
				d3.select(this).attr("d", kepler_path);
				})
			// .attr("d", kepler_path);   // can't do it this way, it behaves strangely if you do.
			.attr("transform", "scale(0.5)translate(" + width/2 + "," + height/2 + ")");
		
		svg.call(dragobj);

		});		
	});
});

</script>
